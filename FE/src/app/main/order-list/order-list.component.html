<p-toolbar>
  <div class="grid w-100">
    <div class="col-fixed">
      <button
        pButton
        pRipple
        label="Thêm mới"
        icon="pi pi-plus"
        (click)="add()"
      ></button>
    </div>
    <span class="p-float-label col-fixed">
      <p-calendar
        [showClear]="true"
        appendTo="body"
        placeholder="Không chọn"
        dateFormat="dd/MM/yy"
        [(ngModel)]="start"
      ></p-calendar>
      <label for="">Từ ngày</label>
    </span>
    <span class="p-float-label col-fixed">
      <p-calendar
        [showClear]="true"
        appendTo="body"
        placeholder="Không chọn"
        dateFormat="dd/MM/yy"
        [(ngModel)]="end"
      ></p-calendar>
      <label for="">Đến ngày</label>
    </span>
  </div>
</p-toolbar>

<p-table>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 4rem">
        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
      </th>
      <th pSortableColumn="idKhachHang">
        Khách hàng <p-sortIcon field="idKhachHang"></p-sortIcon>
      </th>
      <th pSortableColumn="tinh">
        Địa chỉ <p-sortIcon field="tinh"></p-sortIcon>
      </th>
      <th pSortableColumn="khachHang.sdt">
        Liên hệ <p-sortIcon field="khachHang.sdt"></p-sortIcon>
      </th>
      <th pSortableColumn="status">
        Tình trạng <p-sortIcon field="status"></p-sortIcon>
      </th>
      <th style="width: 4rem"></th>
    </tr>
  </ng-template>
  <ng-template
    pTemplate="body"
    let-item
  >
    <tr>
      <td>
        <p-tableCheckbox [value]="item"></p-tableCheckbox>
      </td>
      <td>
        <div class="font-semibold">
          {{ item.khachHang?.hoTen }}
        </div>
        {{ item.diaChi }}
      </td>
      <td>
        <div
          class="font-senibold"
          pTooltip="Số điện thoại"
        >
          {{ item.khachHang?.sdt }}
        </div>
        <div
          class="font-senibold"
          pTooltip="Huyện"
        >
          {{ item.khachHang?.email }}
        </div>
      </td>
      <td>
        <div class="font-semibold">
          {{ OrderStatus.getDisplayName(item.status) }}
        </div>
        <div>
          YC hủy : <strong> {{ item.yeuCauHuy ? "Có" : "Không" }}</strong>
        </div>
      </td>
      <td>
        <button
          pButton
          pRipple
          class="p-button-sm p-button-text"
          icon="pi pi-pencil"
          (click)="edit(item)"
        ></button>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="100">
        <div class="text-center font-semibold">Không có đơn đặt hàng nào</div>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [style]="{ width: '75vw' }"
  [resizable]="true"
  [maximizable]="true"
  appendTo="body"
  header="Thông tin chi tiết sản phẩm"
  [breakpoints]="[{ '576px': '100vw' }]"
  [(visible)]="formVisible"
  [modal]="true"
>
  <form
    (submit)="submit()"
    class="p-fluid"
    [formGroup]="form"
  >
    <div class="grid">
      <div class="field col">
        <label for="">Khách hàng</label>
        <p-dropdown
          [options]="dsKhachHang"
          optionValue="id"
          optionLabel="hoTen"
          placeholder="Chưa chọn khách hàng"
          [filter]="true"
          filterBy="hoTen,sdt,email"
          [(ngModel)]="selectedKH"
          [ngModelOptions]="{ standalone: true }"
        ></p-dropdown>
      </div>
      <div class="field col">
        <label for="">Số điện thoại</label>
        <input
          type="text"
          pInputText
          [readOnly]="true"
          [ngModel]="selectedKH?.sdt"
          [ngModelOptions]="{ standalone: true }"
        />
      </div>
    </div>
    <div class="grid">
      <div class="field col">
        <label for="">Tỉnh/TP</label>
        <input
          type="text"
          pInputText
          formControlName="tinh"
        />
      </div>
      <div class="field col">
        <label for="">Quận/Huyện</label>
        <input
          type="text"
          pInputText
          formControlName="huyen"
        />
      </div>
      <div class="field col">
        <label for="">Phường/Xã</label>
        <input
          type="text"
          pInputText
          formControlName="xa"
        />
      </div>
      <div class="field col">
        <label for="">Số nhà</label>
        <input
          type="text"
          pInputText
          formControlName="diaChi"
        />
      </div>
    </div>
    <div class="grid">
      <div class="field col">
        <span class="p-float-label">
          <p-dropdown
            [options]="dsSanPham"
            dataKey="id"
            #ddSanPham
          >
            <ng-template
              pTemplate="item"
              let-item
            >
              {{ item.sanPham.tenSP }} | {{ item.sanPham.tenSP }} |
              {{ item.gia | currency : "VND" }}
            </ng-template>
            <ng-template
              pTemplate="selectedItem"
              let-item
            >
              {{ item.sanPham.tenSP }} | {{ item.sanPham.tenSP }} |
              {{ item.gia | currency : "VND" }}
            </ng-template>
          </p-dropdown>
          <label for="">Sản phẩm</label>
        </span>
      </div>
      <div class="field col">
        <span class="p-float-label">
          <p-inputNumber #slSanPham></p-inputNumber>
          <label for="">Số lượng</label>
        </span>
      </div>
      <div class="field col-fixed">
        <button
          pButton
          pRipple
          label="Thêm"
          icon="pi pi-plus"
          [disabled]="slSanPham.value == 0 || ddSanPham.value == undefined"
          (click)="addCT(ddSanPham.value, slSanPham.value)"
        ></button>
      </div>
    </div>
    <div class="field">
      <p-table
        [value]="dsChiTiet"
        dataKey="id"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Sản phẩm</th>
            <th>Số lượng</th>
            <th>Đơn giá</th>
            <th>Tổng</th>
            <th style="width: 4rem"></th>
          </tr>
        </ng-template>
        <ng-template
          pTemplate="body"
          let-item
        >
          <tr>
            <th>{{ item.sanPham?.sanPham?.tenSP }}</th>
            <th>{{ item.soLuong | number }}</th>
            <th>{{ item.donGia | currency : "VND" }}</th>
            <th>{{ item.donGia * item.soLuong | currency : "VND" }}</th>
            <th>
              <div>
                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-sm p-button-text p-button danger p-button-rounded"
                ></button>
              </div>
            </th>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <div class="flex mt-3 justify-content-end">
      <button
        pButton
        pRipple
        label="Lưu"
        class="p-button-outlined p-button-success w-auto"
        icon="fa-regular fa-floppy-disk"
        (click)="submit()"
      ></button>
    </div>
  </ng-template>
</p-dialog>
